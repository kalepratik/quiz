<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dbt Certification Quiz</title>
    <link rel="icon" type="image/png" href="/static/android-chrome-512x512.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/static/android-chrome-512x512.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #4299e1;
            --success-color: #48bb78;
            --warning-color: #ed8936;
            --error-color: #f56565;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --bg-primary: #ffffff;
            --bg-secondary: #f7fafc;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        /* Header with Back to Home button */
        .quiz-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo-section img {
            width: 40px;
            height: 40px;
            border-radius: 8px;
        }
        
        .logo-section h1 {
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .back-home-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .back-home-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Modern Card Design */
        .quiz-container {
            background: var(--bg-primary);
            border-radius: 24px;
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            margin-bottom: 2rem;
        }
        
        .quiz-header-section {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .quiz-header-section h2 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .quiz-header-section p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .quiz-content {
            padding: 2rem;
        }
        
        /* Configuration Section */
        .config-section {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .config-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .config-group {
            margin-bottom: 2rem;
        }
        
        .config-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: block;
        }
        
        .question-pills {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        .question-pill {
            padding: 0.75rem 1.5rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            user-select: none;
            position: relative;
            z-index: 1;
        }
        
        .question-pill:hover {
            border-color: var(--accent-color);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        
        .question-pill.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
            box-shadow: var(--shadow-md);
        }
        
                 .custom-input {
             width: 100%;
             padding: 0.75rem 1rem;
             border: 2px solid var(--border-color);
             border-radius: 12px;
             font-size: 1rem;
             transition: border-color 0.3s ease;
         }
         
         .custom-input:focus {
             outline: none;
             border-color: var(--accent-color);
         }
         
                   .custom-input-pill {
              width: auto;
              min-width: 200px;
              padding: 0.75rem 3.5rem 0.75rem 1.5rem;
              border: 2px solid var(--border-color);
              border-radius: 12px;
              background: var(--bg-primary);
              color: var(--text-primary);
            font-size: 1rem;
              font-weight: 500;
              text-align: center;
              outline: none;
              transition: all 0.3s ease;
              cursor: pointer;
              font-family: inherit;
              position: relative;
          }
         
         .custom-input-pill::placeholder {
             color: var(--text-primary);
             opacity: 1;
         }
         
         .custom-input-pill:hover {
             border-color: var(--accent-color);
             transform: translateY(-1px);
             box-shadow: var(--shadow-sm);
         }
         
         .custom-input-pill:focus {
             border-color: var(--accent-color);
             background: var(--accent-color);
             color: white;
         }
         
                   .custom-input-pill:focus::placeholder {
              color: white;
              opacity: 0.8;
          }
          
                     /* Number input spinner styling */
           .custom-input-pill::-webkit-outer-spin-button,
           .custom-input-pill::-webkit-inner-spin-button {
               -webkit-appearance: auto;
               margin: 0;
               opacity: 1;
               height: 24px;
               width: 24px;
               background: var(--bg-secondary);
               border-radius: 4px;
               margin-right: 0;
               cursor: pointer;
               position: absolute;
               right: 6px;
               top: 50%;
               transform: translateY(-50%);
               z-index: 10;
           }
          
                     /* Firefox */
           .custom-input-pill[type=number] {
               -moz-appearance: auto;
           }
           
           /* Ensure spinner controls are always visible and clickable */
           .custom-input-pill:hover::-webkit-outer-spin-button,
           .custom-input-pill:hover::-webkit-inner-spin-button,
           .custom-input-pill:focus::-webkit-outer-spin-button,
           .custom-input-pill:focus::-webkit-inner-spin-button {
               opacity: 1;
               background: var(--accent-color);
           }
        
        .difficulty-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .difficulty-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            user-select: none;
            position: relative;
            z-index: 1;
        }
        
        .difficulty-btn:hover {
            border-color: var(--accent-color);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        
        .difficulty-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
            box-shadow: var(--shadow-md);
        }
        
        .start-btn {
            width: 100%;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
            opacity: 1;
            position: relative;
            z-index: 1;
        }
        
        .start-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .start-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
                 /* Question Styling - Matching Homepage Format */
         .question {
             margin-bottom: 2rem;
             background: var(--bg-primary);
             border-radius: 16px;
             padding: 2rem;
             box-shadow: var(--shadow-md);
             border: 1px solid var(--border-color);
         }
         
                   .question-header {
            display: flex;
              justify-content: space-between;
            align-items: center;
              margin-bottom: 1.5rem;
          }
          
          .question-label {
              font-size: 0.9rem;
              font-weight: 600;
              color: white;
              background: var(--accent-color);
              padding: 0.5rem 1rem;
              border-radius: 20px;
              display: inline-block;
          }
          
          .question-topic {
              font-size: 0.8rem;
              font-weight: 500;
              color: var(--text-secondary);
              background: var(--bg-secondary);
              padding: 0.4rem 0.8rem;
              border-radius: 16px;
              display: inline-block;
          }
         
                   .question-content {
              margin-bottom: 2rem;
          }
          
          .scenario-section, .question-section {
              margin-bottom: 2rem;
          }
          
          .section-header {
            font-size: 1rem;
              font-weight: 700;
              color: var(--accent-color);
              margin-bottom: 1rem;
          }
          
          .scenario-text {
              font-size: 1rem;
              color: var(--text-primary);
              margin-bottom: 1rem;
            line-height: 1.6;
          }
          
                     .question-text {
               font-size: 1.1rem;
               font-weight: normal;
               color: var(--text-primary);
               margin-bottom: 1.5rem;
               line-height: 1.6;
           }
         
         .code-block {
             background: #1e293b;
             border-radius: 8px;
             padding: 1rem;
             margin: 1rem 0;
             overflow-x: auto;
         }
         
         .code-block pre {
             margin: 0;
             font-family: 'Courier New', monospace;
             font-size: 0.9rem;
             line-height: 1.4;
         }
         
         .code-block code {
             color: #10b981;
             font-family: 'Courier New', monospace;
         }
         
         .ascii-dag-label {
             font-size: 0.9rem;
             color: var(--text-primary);
             margin: 1rem 0 0.5rem 0;
        }
        
        .ascii-diagram {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
              padding: 1.5rem;
              margin: 1rem 0;
              font-family: 'Courier New', monospace;
              font-size: 0.85rem;
              line-height: 1.3;
              white-space: pre;
              overflow-x: auto;
              color: #374151;
              text-align: left;
              box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
          }
          
                     .ascii-diagram pre {
               margin: 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            white-space: pre;
               color: var(--text-primary);
               background: transparent;
               border: none;
               padding: 0;
           }
         
                   .code-inline {
              background: var(--bg-secondary);
              color: var(--text-primary);
              padding: 0.25rem 0.5rem;
              border-radius: 4px;
              font-family: 'Courier New', monospace;
              font-size: 0.9rem;
              border: 1px solid var(--border-color);
              font-weight: normal;
              white-space: pre;
              display: block;
              margin: 1rem 0;
            overflow-x: auto;
        }
        
                 /* Options Styling - Matching Homepage Format */
        .options {
            display: flex;
            flex-direction: column;
             gap: 0.75rem;
        }
         
        .option {
            display: flex;
            align-items: center;
             padding: 1rem 1.5rem;
             border: 2px solid var(--border-color);
            border-radius: 12px;
             background: var(--bg-secondary);
            cursor: pointer;
             transition: all 0.3s ease;
            text-align: left;
             font-weight: 500;
        }
         
        .option:hover {
             border-color: var(--accent-color);
             background: var(--bg-primary);
            transform: translateY(-1px);
             box-shadow: var(--shadow-sm);
        }
         
        .option.selected {
             border-color: var(--accent-color);
             background: var(--accent-color);
             color: white;
             box-shadow: var(--shadow-md);
         }
         
        .option-letter {
            font-weight: 600;
             color: var(--text-secondary);
             margin-right: 1rem;
             min-width: 20px;
            text-align: center;
        }
         
         .option.selected .option-letter {
             color: white;
         }
         
        .option-text {
            flex: 1;
            font-size: 1rem;
             color: var(--text-primary);
            line-height: 1.5;
        }
         
         .option.selected .option-text {
             color: white;
         }
        
        /* Navigation */
        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid var(--bg-secondary);
        }
        
        .nav-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .nav-btn:hover:not(:disabled) {
            border-color: var(--accent-color);
            transform: translateY(-1px);
        }
        
        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .submit-btn {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }
        
        .submit-btn:hover {
            background: #38a169;
            border-color: #38a169;
        }
        
        /* Progress Bar */
        .progress-container {
            margin-bottom: 2rem;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            transition: width 0.3s ease;
        }
        
        .progress-text {
            text-align: center;
            margin-top: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* Results Section */
        .results {
             text-align: center;
            padding: 2rem;
        }
        
        .score {
            font-size: 3rem;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 1rem;
        }
        
        .score-text {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }
        
        .result-buttons {
                 display: flex;
            gap: 1rem;
            justify-content: center;
                 flex-wrap: wrap;
        }
        
        .restart-btn, .pro-btn {
            padding: 1rem 2rem;
             border-radius: 12px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-flex;
             align-items: center;
            gap: 0.5rem;
        }
        
        .restart-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            cursor: pointer;
        }
        
        .restart-btn:hover {
            background: #3182ce;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .pro-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
             color: white;
             border: none;
             cursor: pointer;
        }
        
                .pro-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        /* PRO Plan Promotion */
        .pro-promotion {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            padding: 2rem;
            margin-top: 2rem;
            text-align: center;
        }
        
        .pro-promotion h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .pro-promotion p {
            margin-bottom: 1.5rem;
            opacity: 0.9;
        }
        
        .pro-features {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .pro-feature {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        
        .pro-feature i {
            color: #48bb78;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
        }
        
        .loading i {
            font-size: 2rem;
            color: var(--accent-color);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header-content {
                padding: 0 1rem;
            }
            
            .quiz-content {
                padding: 1rem;
            }
            
            .question-pills, .difficulty-buttons {
                justify-content: center;
            }
            
            .result-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .pro-features {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <!-- Header with Back to Home button -->
    <header class="quiz-header">
        <div class="header-content">
            <div class="logo-section">
                <img src="/static/dbt-bit-standalone.png" alt="dbt Logo">
                <h1>dbt Certification Quiz</h1>
        </div>
            <a href="/" class="back-home-btn">
                <i class="fas fa-arrow-left"></i>
                Back to Home
            </a>
        </div>
    </header>

    <div class="container">
        <!-- Configuration Screen -->
        <div id="config" class="quiz-container">
            <div class="quiz-header-section">
                <h2>Configure Your Quiz</h2>
                <p>Choose your preferred settings to get started</p>
            </div>
            
            <div class="quiz-content">
                <div class="config-section">
                    <div class="config-group">
                        <label class="config-label">Number of Questions</label>
                        <div class="question-pills">
                             <div class="question-pill active" data-value="5">5 Questions</div>
                             <div class="question-pill" data-value="10">10 Questions</div>
                             <div class="question-pill" data-value="15">15 Questions</div>
                             <div class="question-pill" data-value="20">20 Questions</div>
                             <div class="question-pill" data-value="25">25 Questions</div>
                                                           <input type="number" id="customQuestionCount" class="question-pill custom-input-pill" placeholder="Custom" data-value="custom" min="1" max="35">
                            </div>
                        </div>
                    
                    <div class="config-group">
                        <label class="config-label">Difficulty Level</label>
                        <div class="difficulty-buttons">
                            <div class="difficulty-btn active" data-difficulty="1">Beginner</div>
                            <div class="difficulty-btn" data-difficulty="2">Intermediate</div>
                            <div class="difficulty-btn" data-difficulty="3">Advanced</div>
                        </div>
                            </div>
                    
                                         <button class="start-btn" id="startBtn" disabled>Start Quiz</button>
                </div>
            </div>
        </div>

        <!-- Loading Screen -->
        <div id="loading" class="quiz-container" style="display: none;">
            <div class="loading">
                <i class="fas fa-spinner"></i>
                <p>Loading your quiz...</p>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz" class="quiz-container" style="display: none;">
            <div class="quiz-header-section">
                <h2>dbt Certification Quiz</h2>
                <p>Test your knowledge and prepare for success</p>
            </div>
            
            <div class="quiz-content">
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Question 1 of 10</div>
                </div>
                
                <div class="question" id="questionContainer">
                    <!-- Question content will be loaded here -->
                </div>
                
                <div class="navigation">
                    <button class="nav-btn" id="prevBtn" onclick="previousQuestion()" disabled>Previous</button>
                    <button class="nav-btn" id="nextBtn" onclick="nextQuestion()">Next</button>
                    <button class="nav-btn submit-btn" id="submitBtn" onclick="submitQuiz()" style="display: none;">Submit Quiz</button>
                </div>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="results" class="quiz-container" style="display: none;">
            <div class="quiz-header-section">
                <h2>Quiz Results</h2>
                <p>Great job completing the quiz!</p>
            </div>
            
            <div class="results">
                <div class="score" id="score"></div>
                <div class="score-text" id="scoreText"></div>
                
                <div class="result-buttons">
                    <button class="restart-btn" onclick="restartQuiz()">
                        <i class="fas fa-redo"></i>
                        Take Another Free Quiz
                    </button>
                    <button class="pro-btn" onclick="upgradeToPro()">
                        <i class="fas fa-crown"></i>
                        Upgrade to PRO
                    </button>
            </div>
                
                <!-- PRO Plan Promotion -->
                <div class="pro-promotion">
                    <h3>🚀 Unlock Your Full Potential with PRO</h3>
                    <p>Get unlimited access to advanced features and comprehensive study materials</p>
                    
                                         <div class="pro-features">
                         <div class="pro-feature">
                             <i class="fas fa-check-circle"></i>
                             <span>Unlimited Quizzes</span>
                         </div>
                         <div class="pro-feature">
                             <i class="fas fa-check-circle"></i>
                             <span>Correct Answers with Explanations</span>
                         </div>
                         <div class="pro-feature">
                             <i class="fas fa-check-circle"></i>
                             <span>Practice Tests</span>
                         </div>
                     </div>
                    
                    <button class="pro-btn" onclick="upgradeToPro()">
                        <i class="fas fa-crown"></i>
                        Upgrade to PRO
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let quizData = null;
        let currentQuestion = 0;
        let answers = [];

        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            
             // Show configuration screen by default
             document.getElementById('config').style.display = 'block';
             document.getElementById('loading').style.display = 'none';
             document.getElementById('quiz').style.display = 'none';
             document.getElementById('results').style.display = 'none';
             
            // Initialize configuration immediately
             initializeConfig();
            
            // Load question stats
            loadQuestionStats();
        });
        
        // Also keep window.onload as backup
        window.onload = function() {
            console.log('Window loaded, checking if already initialized...');
            
            // Only initialize if not already done
            if (!document.querySelector('.difficulty-btn').hasAttribute('data-initialized')) {
                initializeConfig();
            }
        };

        async function loadQuestionStats() {
            try {
                const response = await fetch('/api/question-stats');
                const stats = await response.json();
                
                // Update the total count display
                document.getElementById('totalCount').textContent = stats.total;
                
                // Update max values for custom input and validation
                const customInput = document.getElementById('customQuestionCount');
                customInput.max = stats.total;
                
                // Update validation logic
                window.maxQuestions = stats.total;
                
            } catch (error) {
                console.error('Error loading question stats:', error);
                // Keep default value of 35 if API fails
                document.getElementById('totalCount').textContent = '35';
            }
        }

         function initializeConfig() {
            console.log('Initializing configuration...');
            
                         // Question pill interactions (excluding the input)
             const questionPills = document.querySelectorAll('.question-pill:not(.custom-input-pill)');
             const customInput = document.getElementById('customQuestionCount');
             
            console.log('Found question pills:', questionPills.length);
            
                                                                                                       questionPills.forEach((pill, index) => {
                   console.log(`Adding click listener to pill ${index}:`, pill.textContent);
                   pill.addEventListener('click', function(e) {
                       e.preventDefault();
                       e.stopPropagation();
                       console.log('Question pill clicked:', this.dataset.value, this.textContent);
                     // Remove active class from all pills
                     questionPills.forEach(p => p.classList.remove('active'));
                       // Remove active class from custom input
                       customInput.classList.remove('active');
                     // Add active class to clicked pill
                     this.classList.add('active');
                       // Update custom input value (but only if it's not the input itself)
                       if (this !== customInput) {
                     customInput.value = this.dataset.value;
                       }
                     updateStartButton();
                 });
             });
             
                                                                               // Custom input interactions - simplified
             customInput.addEventListener('input', function() {
                   console.log('Custom input changed:', this.value);
                   
                   // Only allow numbers
                   this.value = this.value.replace(/[^0-9]/g, '');
                   
                 const value = parseInt(this.value);
                   const maxQuestions = window.maxQuestions || 35;
                   
                   if (value > 0 && value <= maxQuestions) {
                     // Remove active class from all pills
                     questionPills.forEach(p => p.classList.remove('active'));
                       // Add active class to custom input
                       this.classList.add('active');
                   } else if (value === 0 || isNaN(value)) {
                       // Reset if invalid
                       this.classList.remove('active');
                   }
                   
                     updateStartButton();
               });
              
                                                           // Handle spinner button clicks and value changes
                customInput.addEventListener('change', function() {
                    console.log('Custom input value changed:', this.value);
                    
                    const value = parseInt(this.value);
                    const maxQuestions = window.maxQuestions || 35;
                    
                    // Ensure value is within bounds
                    if (value < 1) {
                        this.value = 1;
                    } else if (value > maxQuestions) {
                        this.value = maxQuestions;
                    }
                    
                    // Always activate custom input when spinner is used
                    questionPills.forEach(p => p.classList.remove('active'));
                    this.classList.add('active');
                    
                    updateStartButton();
                });
             

             
                           // Custom input click handler
              customInput.addEventListener('click', function(e) {
                  e.preventDefault();
                  e.stopPropagation();
                  console.log('Custom input clicked');
                  // Remove active class from all pills
                  questionPills.forEach(p => p.classList.remove('active'));
                  // Add active class to custom input
                  this.classList.add('active');
                  updateStartButton();
              });
              
                                                           // Add specific event listeners for spinner buttons
                customInput.addEventListener('mouseup', function(e) {
                    // Check if the click was on a spinner button
                    const rect = this.getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const isSpinnerClick = clickX > rect.width - 40; // Approximate spinner area
                    
                    if (isSpinnerClick) {
                        console.log('Spinner button clicked');
                        // Force update after spinner change
                        setTimeout(() => {
                            const value = parseInt(this.value);
                            if (value > 0) {
                                questionPills.forEach(p => p.classList.remove('active'));
                                this.classList.add('active');
                                updateStartButton();
                            }
                        }, 50);
                 }
             });
             
             // Difficulty button interactions
             const difficultyBtns = document.querySelectorAll('.difficulty-btn');
            console.log('Found difficulty buttons:', difficultyBtns.length);
            
            difficultyBtns.forEach((btn, index) => {
                console.log(`Adding click listener to difficulty button ${index}:`, btn.textContent);
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Difficulty button clicked:', this.dataset.difficulty, this.textContent);
                     // Remove active class from all buttons
                     difficultyBtns.forEach(b => b.classList.remove('active'));
                     // Add active class to clicked button
                     this.classList.add('active');
                     updateStartButton();
                 });
             });
            
            // Start button interaction
            const startBtn = document.getElementById('startBtn');
            console.log('Adding click listener to start button');
            startBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Start button clicked!');
                startQuiz();
            });
             
             // Initialize start button state
             updateStartButton();
            console.log('Configuration initialized');
         }
         
         function updateStartButton() {
             const customInput = document.getElementById('customQuestionCount');
               const value = parseInt(customInput.value);
               const maxQuestions = window.maxQuestions || 35;
             
               // Check if any question pill is active (including the default "5 Questions")
                 const activePill = document.querySelector('.question-pill.active');
               const isCustomActive = customInput.classList.contains('active');
               
               const startBtn = document.getElementById('startBtn');
               
               // Enable button if:
               // 1. Custom input has a valid value, OR
               // 2. A regular pill is active (like the default "5 Questions")
               if ((value > 0 && value <= maxQuestions) || (activePill && !isCustomActive)) {
                   startBtn.disabled = false;
                   startBtn.style.opacity = '1';
             } else {
                   startBtn.disabled = true;
                   startBtn.style.opacity = '0.6';
             }
         }
         
         async function startQuiz() {
             const questionCount = parseInt(document.getElementById('customQuestionCount').value) || 5;
             const difficulty = document.querySelector('.difficulty-btn.active').dataset.difficulty;
             
             // Show loading screen
             document.getElementById('config').style.display = 'none';
             document.getElementById('loading').style.display = 'block';
             
            try {
                const response = await fetch('/api/configure-quiz', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        questionCount: questionCount,
                        difficulty: parseInt(difficulty)
                    })
                });
                
                if (response.ok) {
                    quizData = await response.json();
                    currentQuestion = 0;
                 answers = new Array(quizData.questions.length).fill(null);
                 
                    // Hide loading, show quiz
                 document.getElementById('loading').style.display = 'none';
                 document.getElementById('quiz').style.display = 'block';
                 
                    displayQuestion();
                } else {
                    throw new Error('Failed to configure quiz');
                }
             } catch (error) {
                console.error('Error starting quiz:', error);
                alert('Failed to start quiz. Please try again.');
                 document.getElementById('loading').style.display = 'none';
                 document.getElementById('config').style.display = 'block';
             }
         }

                 function formatQuestionText(text) {
             // Handle code blocks (```...```)
             text = text.replace(/```([\s\S]*?)```/g, function(match, code) {
                 return `<code class="code-inline">${code.trim()}</code>`;
             });
             
             // Convert inline backticks to proper code formatting
             text = text.replace(/`([^`]+)`/g, '<code class="code-inline">$1</code>');
             
             // Handle bold text (**text**) - convert to <strong> tags
             text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
             
             // Remove duplicate "What will happen?" if it appears at the end
             text = text.replace(/\n\nQuestion:\nWhat will happen\?\s*$/, '');
             
             return text;
         }
         

         
                   function displayQuestion() {
              const question = quizData.questions[currentQuestion];
              const container = document.getElementById('questionContainer');
              
                          // Update progress
              const progress = ((currentQuestion + 1) / quizData.questions.length) * 100;
              document.getElementById('progressFill').style.width = progress + '%';
              document.getElementById('progressText').textContent = `Question ${currentQuestion + 1} of ${quizData.questions.length}`;
              
                                           // Build question HTML in the same format as homepage sample
               let questionHTML = `
                   <div class="question-header">
                       <div class="question-label">Question ${currentQuestion + 1}</div>
                       <div class="question-topic">${question.topic || 'General'}</div>
                            </div>
                   <div class="question-content">
               `;
              
                             // Display the question content directly
               questionHTML += `
                   <div class="question-text">${formatQuestionText(question.question)}</div>
               `;
               
               questionHTML += `</div>`;
            
            // Add options
            questionHTML += '<div class="options">';
            question.options.forEach((option, index) => {
                const letter = String.fromCharCode(65 + index); // A, B, C, D
                const isSelected = answers[currentQuestion] === index;
                questionHTML += `
                    <div class="option ${isSelected ? 'selected' : ''}" onclick="selectOption(${index})">
                        <div class="option-letter">${letter}</div>
                        <div class="option-text">${option}</div>
                        </div>
                    `;
            });
            questionHTML += '</div>';
            
            container.innerHTML = questionHTML;
            
            // Update navigation buttons
            updateNavigationButtons();
        }

        function selectOption(optionIndex) {
            answers[currentQuestion] = optionIndex;
            
            // Update visual selection
            const options = document.querySelectorAll('.option');
            options.forEach((option, index) => {
                if (index === optionIndex) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
            
            updateNavigationButtons();
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');
            
            prevBtn.disabled = currentQuestion === 0;
            nextBtn.disabled = currentQuestion === quizData.questions.length - 1;
            
            // Show submit button on last question if answered
            if (currentQuestion === quizData.questions.length - 1) {
                nextBtn.style.display = 'none';
                submitBtn.style.display = answers[currentQuestion] !== null ? 'block' : 'none';
            } else {
                nextBtn.style.display = 'block';
                submitBtn.style.display = 'none';
            }
        }

        function previousQuestion() {
            if (currentQuestion > 0) {
                currentQuestion--;
                displayQuestion();
            }
        }

        function nextQuestion() {
            if (currentQuestion < quizData.questions.length - 1) {
                currentQuestion++;
                displayQuestion();
            }
        }

        async function submitQuiz() {
            // Show loading
            document.getElementById('quiz').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            
            try {
                const response = await fetch('/api/submit-quiz', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        answers: answers,
                        questions: quizData.questions
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    displayResults(result);
                } else {
                    throw new Error('Failed to submit quiz');
                }
            } catch (error) {
                console.error('Error submitting quiz:', error);
                alert('Failed to submit quiz. Please try again.');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('quiz').style.display = 'block';
            }
        }

        function displayResults(result) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results').style.display = 'block';
            
            const score = document.getElementById('score');
            const scoreText = document.getElementById('scoreText');
            
            const percentage = ((result.correctAnswers / result.totalQuestions) * 100).toFixed(2);
            score.textContent = `${percentage}%`;
            
            if (percentage >= 80) {
                scoreText.textContent = 'Excellent! You have a strong understanding of dbt concepts. Upgrade to PRO to see detailed explanations and unlock unlimited practice!';
            } else if (percentage >= 60) {
                scoreText.textContent = 'Good job! Keep practicing to improve your skills. Get PRO to see correct answers with explanations!';
            } else {
                scoreText.textContent = 'Keep studying! Review the concepts and try again. Upgrade to PRO for detailed explanations and unlimited practice tests!';
            }
        }

                 function restartQuiz() {
             // Reset to configuration screen
             document.getElementById('results').style.display = 'none';
             document.getElementById('config').style.display = 'block';
             
             // Reset form
             const customInput = document.getElementById('customQuestionCount');
             customInput.value = '';
             customInput.classList.remove('active');
             
             document.querySelectorAll('.question-pill').forEach(p => p.classList.remove('active'));
             document.querySelector('.question-pill[data-value="5"]').classList.add('active');
             document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
             document.querySelector('.difficulty-btn[data-difficulty="2"]').classList.add('active');
             
             // Enable start button since "5 Questions" is selected by default
             const startBtn = document.getElementById('startBtn');
             startBtn.disabled = false;
             startBtn.style.opacity = '1';
         }

        function upgradeToPro() {
            // Check if user is authenticated
            fetch('/api/user-info')
                .then(response => response.json())
                .then(data => {
                    if (data.authenticated) {
                        // User is signed in, redirect to payment page
                        window.location.href = '/payment';
                    } else {
                        // User is not signed in, redirect to sign in page
                        window.location.href = '/signin';
                    }
                })
                .catch(error => {
                    console.error('Error checking authentication:', error);
                    // Fallback to sign in page
                    window.location.href = '/signin';
                });
         }
    </script>
    
    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-8 mt-12">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex flex-col md:flex-row items-center justify-between">
                <div class="flex items-center space-x-3 mb-4 md:mb-0">
                    <img src="/static/dbt-bit-standalone.png" alt="dbt logo" class="h-8 w-auto">
                    <span class="text-xl font-bold">Quiz</span>
                </div>
                
                <div class="flex items-center space-x-6 text-sm">
                    <a href="/legal" class="text-gray-400 hover:text-white transition-colors">Legal</a>
                    <a href="/contact" class="text-gray-400 hover:text-white transition-colors">Contact</a>
                    <a href="/" class="text-gray-400 hover:text-white transition-colors">Home</a>
                </div>
            </div>
            
            <div class="border-t border-gray-800 mt-6 pt-6 text-center">
                <p class="text-gray-400 text-sm">
                    © 2024 dbt Quiz. Built for analytics engineers, by analytics engineers.
                </p>
            </div>
        </div>
    </footer>
</body>
</html>